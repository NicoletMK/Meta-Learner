<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meta Learning With Bot Sparkle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            doc,
            setDoc,
            collection,
            addDoc,
            getDoc
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&display=swap');

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background: linear-gradient(to bottom right, #f8fafc, #e2e8f0);
            color: #1a202c;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            overflow-y: hidden;
        }

        .container {
            max-width: 95%;
            width: 95%;
            padding: 2rem;
            background-color: #fff;
            border-radius: 2rem;
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.1), 0 5px 10px -5px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease-in-out;
            border: 4px solid #a5b4fc;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
            max-height: 100vh;
        }
        @media (min-width: 1024px) {
            .container {
                width: auto;
                max-width: 1024px;
            }
        }
        .puzzle-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin: 2rem auto;
            max-width: 600px;
        }
        .puzzle-item {
            width: 100%;
            aspect-ratio: 1 / 1;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 1rem;
            background-color: #cbd5e1;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s;
            box-shadow: inset 0 -6px 0 rgba(0,0,0,0.2);
            font-size: clamp(1rem, 8vw, 3rem);
            user-select: none;
            color: #1a202c;
            font-weight: bold;
        }
        .puzzle-item:hover:not(.flipped):not(.matched) {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px -2px rgba(0, 0, 0, 0.15);
        }
        .puzzle-item.flipped {
            background-color: #fff;
            box-shadow: 0 6px 10px -2px rgba(0, 0, 0, 0.1);
        }
        .puzzle-item.matched {
            background-color: #6ee7b7;
            transform: scale(0.95);
            cursor: default;
            animation: pop-match 0.5s ease-out;
        }
        @keyframes pop-match {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(0.95); }
        }
        .button-primary {
            background-color: #818cf8;
            color: white;
            padding: 0.75rem 2.5rem;
            border-radius: 9999px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
            cursor: pointer;
            border: 3px solid #6366f1;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .button-primary:hover {
            background-color: #6366f1;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }
        .button-primary:active {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .text-robot {
            color: #ef4444;
            font-weight: bold;
        }
        .input-field {
            width: 100%;
            max-width: 300px;
            padding: 0.75rem;
            border-radius: 1rem;
            border: 2px solid #a5b4fc;
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        .page-title {
            font-size: 3rem;
            font-weight: bold;
            color: #4f46e5;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        .round-card {
            background-color: #f0f4f8;
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 3px solid #c7d2fe;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: transform 0.3s ease-in-out;
        }
        .round-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 10px rgba(0,0,0,0.15);
        }
        .award-icon {
            font-size: 5rem;
            line-height: 1;
        }
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        .processing-cursor {
            cursor: wait !important;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center">
    <div class="container text-center">
        <h1 class="page-title">ğŸ§  Meta Learning With Bot Sparkle ğŸ¤–</h1>
        <div id="app-content"></div>
    </div>

    <script>
        const state = {
            currentScreen: 'intro',
            steps: 0,
            humanSteps: 0,
            humanSteps2: 0,
            naiveSteps: 0,
            metaSteps: 0,
            puzzle: [],
            isProcessing: false,
            puzzleElements: [],
            knowledgeBase: {},
            startTime: null,
            humanTime: null,
            humanTime2: null,
            naiveTime: null,
            metaTime: null,
            timerInterval: null,
            db: null,
            auth: null,
            userId: null,
            appId: null,
        };

        const appContent = document.getElementById('app-content');
        const delay = 500;

        async function initializeFirebase() {
            try {
                state.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const firebaseApp = window.firebase.initializeApp(firebaseConfig);
                state.auth = window.firebase.getAuth(firebaseApp);
                state.db = window.firebase.getFirestore(firebaseApp);

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await window.firebase.signInWithCustomToken(state.auth, initialAuthToken);
                } else {
                    await window.firebase.signInAnonymously(state.auth);
                }

                window.firebase.onAuthStateChanged(state.auth, (user) => {
                    if (user) {
                        state.userId = user.uid;
                        showIntro();
                    } else {
                        state.userId = null;
                        showIntro();
                    }
                });

            } catch (e) {
                console.error("Error initializing Firebase:", e);
                showIntro();
            }
        }
        
        async function saveUserData(userData) {
            if (!state.userId || !state.db) {
                console.warn("User or database not available. Data will not be saved.");
                return;
            }
            const userProfileRef = window.firebase.doc(state.db, `artifacts/${state.appId}/users/${state.userId}/user_data/profile`);
            try {
                await window.firebase.setDoc(userProfileRef, userData, { merge: true });
                console.log("User data saved successfully!");
            } catch (e) {
                console.error("Error saving user data:", e);
            }
        }
        
        async function saveGameRecord() {
            if (!state.userId || !state.db) {
                console.warn("User or database not available. Game record will not be saved.");
                return;
            }
            const gameRecordsRef = window.firebase.collection(state.db, `artifacts/${state.appId}/users/${state.userId}/game_records`);
            const gameData = {
                date: new Date().toISOString(),
                human_steps_1: state.humanSteps,
                human_time_1: state.humanTime,
                naive_bot_steps: state.naiveSteps,
                naive_bot_time: state.naiveTime,
                meta_bot_steps: state.metaSteps,
                meta_bot_time: state.metaTime,
                human_steps_2: state.humanSteps2,
                human_time_2: state.humanTime2,
            };
            try {
                await window.firebase.addDoc(gameRecordsRef, gameData);
                console.log("Game record saved successfully!");
            } catch (e) {
                console.error("Error saving game record:", e);
            }
        }

        function createPuzzleGrid(items) {
            const grid = document.createElement('div');
            grid.className = 'puzzle-grid';
            state.puzzleElements = [];
            items.forEach((item, index) => {
                const puzzleItem = document.createElement('div');
                puzzleItem.className = 'puzzle-item';
                puzzleItem.dataset.value = item;
                puzzleItem.dataset.index = index;
                state.puzzleElements.push(puzzleItem);
                grid.appendChild(puzzleItem);
            });
            appContent.appendChild(grid);
        }

        function flipCard(index) {
            const card = state.puzzleElements[index];
            card.classList.add('flipped');
            card.innerHTML = state.puzzle[index];
            return new Promise(resolve => setTimeout(resolve, delay));
        }

        function unflipCard(index) {
            const card = state.puzzleElements[index];
            card.classList.remove('flipped');
            card.innerHTML = '';
            return new Promise(resolve => setTimeout(resolve, delay));
        }

        function matchCards(index1, index2) {
            const card1 = state.puzzleElements[index1];
            const card2 = state.puzzleElements[index2];
            card1.classList.add('matched');
            card2.classList.add('matched');
            card1.removeEventListener('click', handleCardClick);
            card2.removeEventListener('click', handleCardClick);
            return new Promise(resolve => setTimeout(resolve, delay));
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        function startTimer() {
            state.startTime = Date.now();
            if (state.timerInterval) clearInterval(state.timerInterval);
            state.timerInterval = setInterval(() => {
                const elapsedTime = (Date.now() - state.startTime) / 1000;
                const timerEl = document.getElementById('timer');
                if (timerEl) {
                    timerEl.innerText = elapsedTime.toFixed(2);
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(state.timerInterval);
        }

        function showIntro() {
            state.currentScreen = 'intro';
            appContent.innerHTML = `
                <h2 class="text-3xl font-bold mb-4 text-purple-600">ğŸ§  Think Like a Human! ğŸ§ </h2>
                <p class="mb-4 text-xl">Hello! I'm Bot Sparkle, your little robot friend. I need your help to understand something special: meta-learning.</p>
                <p class="mb-4 text-xl">A simple bot like me can only solve one puzzle at a time. But your amazing brain can "learn how to learn" from past experiences!</p>
                <p class="mb-6 text-xl">Let's see if your brain's super memory can solve a puzzle faster than a robot's simple memory. Are you ready for the adventure?</p>
                <button id="startButton" class="button-primary">Let's Begin!</button>
            `;
            document.getElementById('startButton').addEventListener('click', showLogin);
        }
        
        function showLogin() {
            state.currentScreen = 'login';
            appContent.innerHTML = `
                <h2 class="text-3xl font-bold mb-4 text-purple-600">Tell Us About You!</h2>
                <p class="mb-4 text-lg">Help Bot Sparkle learn by sharing a little bit about yourself.</p>
                <form id="loginForm" class="flex flex-col items-center">
                    <input type="text" id="firstName" placeholder="Your First Name" class="input-field" required>
                    <input type="text" id="lastName" placeholder="Your Last Name" class="input-field" required>
                    <input type="number" id="age" placeholder="Your Age" class="input-field" min="1" required>
                    <input type="text" id="grade" placeholder="Your Grade" class="input-field" required>
                    <button type="submit" class="button-primary mt-4">Play!</button>
                </form>
            `;

            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const firstName = document.getElementById('firstName').value;
                const lastName = document.getElementById('lastName').value;
                const age = document.getElementById('age').value;
                const grade = document.getElementById('grade').value;
                
                const userData = {
                    firstName,
                    lastName,
                    age: parseInt(age, 10),
                    grade
                };

                await saveUserData(userData);
                showHumanPractice();
            });
        }

        function showHumanPractice() {
            state.currentScreen = 'human-practice';
            state.steps = 0;
            state.puzzle = ['ğŸ±', 'ğŸ±', 'ğŸ¶', 'ğŸ¶', 'ğŸ»', 'ğŸ»', 'ğŸ¦Š', 'ğŸ¦Š', 'ğŸ¸', 'ğŸ¸', 'ğŸ¨', 'ğŸ¨', 'ğŸ¼', 'ğŸ¼', 'ğŸ°', 'ğŸ°'];
            shuffleArray(state.puzzle);
            appContent.innerHTML = `
                <h2 class="text-3xl font-bold mb-4 text-blue-600">Round 1: You vs. the Puzzle!</h2>
                <p class="text-xl mb-4">You're the superstar! Let's see how fast you can find all the matching pairs. This is our starting point!</p>
                <div class="flex justify-center items-center space-x-8 text-2xl font-bold mt-4">
                    <div class="text-purple-600">Steps: <span id="stepCounter">0</span></div>
                    <div class="text-green-600">Time: <span id="timer">0.00</span>s</div>
                </div>
            `;
            createPuzzleGrid(state.puzzle);
            humanPlay();
            startTimer();
        }

        function showNaiveBot() {
            state.humanSteps = state.steps;
            state.humanTime = (Date.now() - state.startTime) / 1000;
            stopTimer();
            state.currentScreen = 'naive-bot';
            state.steps = 0;
            state.puzzle = ['ğŸ™', 'ğŸ™', 'ğŸ ', 'ğŸ ', 'ğŸ³', 'ğŸ³', 'ğŸ¬', 'ğŸ¬', 'ğŸ¦€', 'ğŸ¦€', 'ğŸŒŸ', 'ğŸŒŸ', 'ğŸ¦ˆ', 'ğŸ¦ˆ', 'ğŸ¢', 'ğŸ¢'];
            shuffleArray(state.puzzle);
            appContent.innerHTML = `
                <h2 class="text-3xl font-bold mb-4 text-red-600">Round 2: Watch Bot Sparkle!</h2>
                <p class="text-xl mb-4">Bot Sparkle will try to solve a new puzzle with a random guess strategy. It doesn't remember anything from the first round. Let's see how it does!</p>
                <div class="flex justify-center items-center space-x-8 text-2xl font-bold mt-4">
                    <div class="text-purple-600">Steps: <span id="stepCounter">0</span></div>
                    <div class="text-green-600">Time: <span id="timer">0.00</span>s</div>
                </div>
            `;
            createPuzzleGrid(state.puzzle);
            state.puzzleElements.forEach(item => item.style.cursor = 'default');
            startTimer();
            naiveBotPlay();
        }
        
        function showMetaBot() {
            state.naiveSteps = state.steps;
            state.naiveTime = (Date.now() - state.startTime) / 1000;
            stopTimer();
            state.currentScreen = 'meta-bot';
            state.steps = 0;
            state.knowledgeBase = {};
            state.puzzle = ['â­', 'â­', 'â˜ï¸', 'â˜ï¸', 'â˜€ï¸', 'â˜€ï¸', 'ğŸŒˆ', 'ğŸŒˆ', 'âš¡', 'âš¡', 'â„ï¸', 'â„ï¸', 'ğŸŒ™', 'ğŸŒ™', 'â˜”', 'â˜”'];
            shuffleArray(state.puzzle);
            appContent.innerHTML = `
                <h2 class="text-3xl font-bold mb-4 text-green-600">Round 3: Smart Bot Sparkle!</h2>
                <p class="text-xl mb-4">Bot Sparkle has now learned a better strategy. It will remember the location of each card it flips! Look at how much faster it is now.</p>
                <div class="flex justify-center items-center space-x-8 text-2xl font-bold mt-4">
                    <div class="text-purple-600">Steps: <span id="stepCounter">0</span></div>
                    <div class="text-green-600">Time: <span id="timer">0.00</span>s</div>
                </div>
            `;
            createPuzzleGrid(state.puzzle);
            state.puzzleElements.forEach(item => item.style.cursor = 'default');
            startTimer();
            metaBotPlay();
        }

        function showHumanAfterLearning() {
            state.metaSteps = state.steps;
            state.metaTime = (Date.now() - state.startTime) / 1000;
            stopTimer();
            state.currentScreen = 'human-after-learning';
            state.steps = 0;
            state.puzzle = ['ğŸ°', 'ğŸ°', 'ğŸª', 'ğŸª', 'ğŸ©', 'ğŸ©', 'ğŸ«', 'ğŸ«', 'ğŸ¬', 'ğŸ¬', 'ğŸ­', 'ğŸ­', 'ğŸ”', 'ğŸ”', 'ğŸŸ', 'ğŸŸ'];
            shuffleArray(state.puzzle);
            appContent.innerHTML = `
                <h2 class="text-3xl font-bold mb-4 text-yellow-600">Round 4: You're a Memory Champion!</h2>
                <p class="text-xl mb-4">It's your turn again! Use your amazing memory and experience to solve this puzzle. Can you beat your own first score?</p>
                <div class="flex justify-center items-center space-x-8 text-2xl font-bold mt-4">
                    <div class="text-purple-600">Steps: <span id="stepCounter">0</span></div>
                    <div class="text-green-600">Time: <span id="timer">0.00</span>s</div>
                </div>
            `;
            createPuzzleGrid(state.puzzle);
            state.puzzleElements.forEach(item => item.style.cursor = 'pointer');
            humanPlay();
            startTimer();
        }

        function showFinalResults() {
            state.humanSteps2 = state.steps;
            state.humanTime2 = (Date.now() - state.startTime) / 1000;
            stopTimer();
            state.currentScreen = 'final-results';
            
            saveGameRecord();

            appContent.innerHTML = `
                <div class="flex flex-col items-center">
                    <h2 class="text-4xl font-bold mb-2 text-green-600">ğŸ† You Did It! You're learning to learn! ğŸ†</h2>
                    <p class="text-2xl font-bold mb-6 text-indigo-700">Let's look at the amazing progress that you and Bot Sparkle made!</p>
                </div>
                <div class="grid results-grid gap-6 mt-6">
                    <div class="round-card bg-blue-100 border-blue-400">
                        <div class="award-icon">ğŸ¥‡</div>
                        <p class="text-lg font-semibold text-blue-800 mt-2">Your First Try</p>
                        <div class="text-4xl font-bold text-blue-600">${state.humanSteps}</div>
                        <p class="text-sm font-semibold text-blue-600">Steps</p>
                        <p class="text-xl font-bold text-blue-600 mt-1">${state.humanTime.toFixed(2)}s</p>
                    </div>
                    <div class="round-card bg-red-100 border-red-400">
                        <div class="award-icon">ğŸ¤–</div>
                        <p class="text-lg font-semibold text-red-800 mt-2">Random Robot</p>
                        <div class="text-4xl font-bold text-red-600">${state.naiveSteps}</div>
                        <p class="text-sm font-semibold text-red-600">Steps</p>
                        <p class="text-xl font-bold text-red-600 mt-1">${state.naiveTime.toFixed(2)}s</p>
                    </div>
                    <div class="round-card bg-green-100 border-green-400">
                        <div class="award-icon">ğŸ§ </div>
                        <p class="text-lg font-semibold text-green-800 mt-2">Smart Robot</p>
                        <div class="text-4xl font-bold text-green-600">${state.metaSteps}</div>
                        <p class="text-sm font-semibold text-green-600">Steps</p>
                        <p class="text-xl font-bold text-green-600 mt-1">${state.metaTime.toFixed(2)}s</p>
                    </div>
                    <div class="round-card bg-purple-100 border-purple-400">
                        <div class="award-icon">ğŸ‘‘</div>
                        <p class="text-lg font-semibold text-purple-800 mt-2">Your Second Try</p>
                        <div class="text-4xl font-bold text-purple-600">${state.humanSteps2}</div>
                        <p class="text-sm font-semibold text-purple-600">Steps</p>
                        <p class="text-xl font-bold text-purple-600 mt-1">${state.humanTime2.toFixed(2)}s</p>
                    </div>
                </div>
                <p class="mt-8 text-2xl font-bold text-indigo-700">Just like Bot Sparkle, you didn't just solve a puzzleâ€”you learned how to learn a puzzle!</p>
                <p class="mt-2 text-xl text-gray-600">You proved that practice and memory make you super-smart!</p>
                <button id="resetButton" class="button-primary mt-6">Play Again!</button>
            `;
            document.getElementById('resetButton').addEventListener('click', showIntro);
        }

        let firstChoice = null;

        async function handleCardClick(e) {
            // New logic: Only allow clicks if no other cards are being processed.
            if (document.body.classList.contains('processing-cursor') || e.target.classList.contains('matched')) {
                return;
            }

            const clickedCard = e.target;
            
            // If the card is already flipped, do nothing.
            if (clickedCard.classList.contains('flipped')) {
                return;
            }

            document.body.classList.add('processing-cursor');
            
            state.steps++;
            document.getElementById('stepCounter').innerText = state.steps;

            await flipCard(parseInt(clickedCard.dataset.index));

            if (firstChoice === null) {
                firstChoice = clickedCard;
                document.body.classList.remove('processing-cursor');
            } else {
                if (firstChoice.dataset.value === clickedCard.dataset.value) {
                    await matchCards(parseInt(firstChoice.dataset.index), parseInt(clickedCard.dataset.index));
                } else {
                    await unflipCard(parseInt(firstChoice.dataset.index));
                    await unflipCard(parseInt(clickedCard.dataset.index));
                }
                
                firstChoice = null;
                document.body.classList.remove('processing-cursor');
                checkWin();
            }
        }

        function humanPlay() {
            firstChoice = null;
            state.puzzleElements.forEach(item => {
                item.removeEventListener('click', handleCardClick);
                item.addEventListener('click', handleCardClick);
            });
        }

        async function naiveBotPlay() {
            let unmatchedIndices = getUnmatchedCardIndices();
            
            async function playTurn() {
                if (unmatchedIndices.length === 0) {
                    setTimeout(showMetaBot, delay * 2);
                    return;
                }
                
                const pick1Index = unmatchedIndices[Math.floor(Math.random() * unmatchedIndices.length)];
                let remainingIndices = unmatchedIndices.filter(index => index !== pick1Index);
                const pick2Index = remainingIndices[Math.floor(Math.random() * remainingIndices.length)];

                await flipCard(pick1Index);
                await flipCard(pick2Index);
                state.steps++;
                document.getElementById('stepCounter').innerText = state.steps;

                if (state.puzzle[pick1Index] === state.puzzle[pick2Index]) {
                    await matchCards(pick1Index, pick2Index);
                } else {
                    await unflipCard(pick1Index);
                    await unflipCard(pick2Index);
                }

                unmatchedIndices = getUnmatchedCardIndices();
                setTimeout(playTurn, delay);
            }
            playTurn();
        }
        
        async function metaBotPlay() {
            let unmatchedIndices = getUnmatchedCardIndices();
            state.knowledgeBase = {};

            async function playTurn() {
                if (unmatchedIndices.length === 0) {
                    setTimeout(showHumanAfterLearning, delay * 2);
                    return;
                }
                
                let pick1Index, pick2Index;
                let foundKnownMatch = false;
                
                for (const value in state.knowledgeBase) {
                    const knownIndices = state.knowledgeBase[value].filter(i => unmatchedIndices.includes(i));
                    if (knownIndices.length === 2) {
                        pick1Index = knownIndices[0];
                        pick2Index = knownIndices[1];
                        foundKnownMatch = true;
                        break;
                    }
                }
                
                if (!foundKnownMatch) {
                    pick1Index = unmatchedIndices[Math.floor(Math.random() * unmatchedIndices.length)];
                    await flipCard(pick1Index);
                    state.steps++;
                    document.getElementById('stepCounter').innerText = state.steps;
                    
                    const value1 = state.puzzle[pick1Index];
                    if (!state.knowledgeBase[value1]) state.knowledgeBase[value1] = [];
                    if (!state.knowledgeBase[value1].includes(pick1Index)) state.knowledgeBase[value1].push(pick1Index);
                    
                    const remainingIndices = unmatchedIndices.filter(i => i !== pick1Index);
                    const knownPairIndex = state.knowledgeBase[value1].find(index => index !== pick1Index && remainingIndices.includes(index));
                    
                    if (knownPairIndex !== undefined) {
                        pick2Index = knownPairIndex;
                        await flipCard(pick2Index);
                        state.steps++;
                        document.getElementById('stepCounter').innerText = state.steps;
                        await matchCards(pick1Index, pick2Index);
                    } else if (remainingIndices.length > 0) {
                        pick2Index = remainingIndices[Math.floor(Math.random() * remainingIndices.length)];
                        await flipCard(pick2Index);
                        state.steps++;
                        document.getElementById('stepCounter').innerText = state.steps;
                        
                        const value2 = state.puzzle[pick2Index];
                        if (!state.knowledgeBase[value2]) state.knowledgeBase[value2] = [];
                        if (!state.knowledgeBase[value2].includes(pick2Index)) state.knowledgeBase[value2].push(pick2Index);
                        
                        if (value1 === value2) {
                            await matchCards(pick1Index, pick2Index);
                        } else {
                            await unflipCard(pick1Index);
                            await unflipCard(pick2Index);
                        }
                    } else {
                        await unflipCard(pick1Index);
                    }
                } else {
                    await flipCard(pick1Index);
                    await flipCard(pick2Index);
                    state.steps++;
                    document.getElementById('stepCounter').innerText = state.steps;
                    await matchCards(pick1Index, pick2Index);
                }
                unmatchedIndices = getUnmatchedCardIndices();
                setTimeout(playTurn, delay);
            }
            playTurn();
        }

        function getUnmatchedCardIndices() {
            const unmatched = [];
            state.puzzleElements.forEach((card, index) => {
                if (!card.classList.contains('matched')) {
                    unmatched.push(index);
                }
            });
            return unmatched;
        }

        function checkWin() {
            const matchedItems = document.querySelectorAll('.puzzle-item.matched');
            if (matchedItems.length === state.puzzle.length) {
                if (state.currentScreen === 'human-practice') {
                    setTimeout(showNaiveBot, 1500);
                } else if (state.currentScreen === 'human-after-learning') {
                    setTimeout(showFinalResults, 1500);
                }
            }
        }

        window.onload = function() {
            initializeFirebase();
        };
    </script>
</body>
</html>